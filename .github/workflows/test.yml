name: Test & Showcase

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  showcase:
    name: Showcase All Commands
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"
      
      - name: Build Module
        shell: pwsh
        run: |
          Write-Host "Building PipelineUtils module..." -ForegroundColor Cyan
          & "${{ github.workspace }}/Build.ps1" -InstallDependencies
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Build failed with exit code $LASTEXITCODE"
            exit 1
          }
          Write-Host "Build completed successfully" -ForegroundColor Green
      
      - name: Showcase PipelineUtils Commands
        shell: pwsh
        run: |
          # Find and import the built module
          $modulePath = Get-ChildItem -Path "${{ github.workspace }}" -Filter "PipelineUtils.psd1" -Recurse | Where-Object { $_.FullName -notlike "*Source*" } | Select-Object -First 1
          
          if (-not $modulePath) {
            Write-Error "Built module not found. Build step may have failed."
            Write-Host "Searching for .psd1 files..."
            Get-ChildItem -Path "${{ github.workspace }}" -Filter "*.psd1" -Recurse | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }
          
          Write-Host "Loading module from: $($modulePath.FullName)" -ForegroundColor Cyan
          Import-Module $modulePath.FullName -Force
          
          # ============================================================================
          # SECTION 1: Write-PipelineSection - Section Headers
          # ============================================================================
          Write-PipelineSection -Text "PipelineUtils Command Showcase" -Boxed
          
          # ============================================================================
          # SECTION 2: Write-PipelineGroupStart/End - Collapsible Groups
          # ============================================================================
          Write-PipelineGroupStart "1. Group Commands (Write-PipelineGroupStart/End)"
          Write-Host "These commands create collapsible groups in the pipeline log"
          Write-PipelineGroupStart "Nested Group Example"
          Write-Host "This is a nested group showing hierarchy"
          Write-PipelineGroupEnd
          Write-PipelineGroupEnd
          
          # ============================================================================
          # SECTION 3: Write-PipelineCommand - Command Messages
          # ============================================================================
          Write-PipelineSection -Text "2. Command Messages (Write-PipelineCommand)" -Boxed
          Write-PipelineCommand "This is a command message for the pipeline log"
          Write-PipelineCommand "Commands help identify important operations"
          
          # ============================================================================
          # SECTION 4: Write-PipelineDebug - Debug Output
          # ============================================================================
          Write-PipelineSection -Text "3. Debug Output (Write-PipelineDebug)" -Boxed
          Write-PipelineDebug "This is debug information"
          Write-PipelineDebug "Debug messages are visible with --debug flag"
          Write-PipelineDebug "GitHub Workspace: ${{ github.workspace }}"
          Write-PipelineDebug "GitHub Repository: ${{ github.repository }}"
          
          # ============================================================================
          # SECTION 5: Write-PipelineWarning - Warning Messages
          # ============================================================================
          Write-PipelineSection -Text "4. Warning Messages (Write-PipelineWarning)" -Boxed
          Write-PipelineWarning -Message "This is a warning message"
          Write-PipelineWarning -Message "Warnings highlight potential issues" -SourcePath "Source/PipelineUtils.psm1" -LineNumber 1
          
          # ============================================================================
          # SECTION 6: Write-PipelineError - Error Messages
          # ============================================================================
          Write-PipelineSection -Text "5. Error Messages (Write-PipelineError)" -Boxed
          Write-PipelineError -Message "This is an error message" -SourcePath "Source/PipelineUtils.psm1" -LineNumber 42
          Write-PipelineError -Message "Errors indicate failure conditions"
          
          # ============================================================================
          # SECTION 7: Write-PipelineProgress - Progress Indicators
          # ============================================================================
          Write-PipelineSection -Text "6. Progress Tracking (Write-PipelineProgress)" -Boxed
          Write-PipelineProgress -Activity "Processing items" -PercentComplete 0
          Start-Sleep -Milliseconds 100
          Write-PipelineProgress -Activity "Processing items" -PercentComplete 25
          Start-Sleep -Milliseconds 100
          Write-PipelineProgress -Activity "Processing items" -PercentComplete 50
          Start-Sleep -Milliseconds 100
          Write-PipelineProgress -Activity "Processing items" -PercentComplete 75
          Start-Sleep -Milliseconds 100
          Write-PipelineProgress -Activity "Processing items" -PercentComplete 100
          
          # ============================================================================
          # SECTION 8: Set-PipelineVariable - Environment Variables
          # ============================================================================
          Write-PipelineSection -Text "8. Variables (Set-PipelineVariable)" -Boxed
          
          Write-Host "Environment variables before setting new ones:" -ForegroundColor Yellow
          Get-ChildItem -Path Env: | Select-Object Name, Value | Format-Table -AutoSize | Out-String | Write-Host
          
          $varName = "SHOWCASE_VAR"
          $varValue = "This is a pipeline variable"
          Write-Host "Setting variable: $varName = $varValue" -ForegroundColor Cyan
          Set-PipelineVariable -Name $varName -Value $varValue
          
          $outputVarName = "OUTPUT_VAR"
          $outputVarValue = "This is an output variable"
          Write-Host "Setting output variable: $outputVarName = $outputVarValue" -ForegroundColor Cyan
          Set-PipelineVariable -Name $outputVarName -Value $outputVarValue -Output
          
          Write-Host "Variables set for subsequent steps" -ForegroundColor Green
          
          # ============================================================================
          # SECTION 9: Set-PipelineSecretValue - Secret Masking
          # ============================================================================
          Write-PipelineSection -Text "9. Secret Masking (Set-PipelineSecretValue)" -Boxed
          
          $secretValue = "my-secret-api-key-12345"
          Write-Host "Secret value BEFORE masking: $secretValue" -ForegroundColor Red
          Write-Host "This value is currently visible in the logs..." -ForegroundColor Yellow
          
          Write-Host "Calling Set-PipelineSecretValue to mask this value..." -ForegroundColor Cyan
          Set-PipelineSecretValue -Value $secretValue
          
          Write-Host "Secret value AFTER masking: $secretValue" -ForegroundColor Green
          Write-Host "Note: GitHub Actions will now mask instances of this value in future log output" -ForegroundColor Cyan
          Write-Host "Any subsequent output containing '$secretValue' will be replaced with '***'" -ForegroundColor Cyan
          
          # ============================================================================
          # SECTION 10: Set-PipelineBuildNumber - Build Number
          # ============================================================================
          Write-PipelineSection -Text "10. Build Number (Set-PipelineBuildNumber)" -Boxed
          $buildNumber = "1.0.0-$(Get-Date -Format 'yyyyMMdd.HHmm')"
          Set-PipelineBuildNumber -BuildNumber $buildNumber
          Write-Host "Build number set to: $buildNumber"
          
          # ============================================================================
          # SECTION 11: Set-PipelineReleaseNumber - Release Number
          # ============================================================================
          Write-PipelineSection -Text "11. Release Number (Set-PipelineReleaseNumber)" -Boxed
          $releaseNumber = "v1.0.0"
          Set-PipelineReleaseNumber -ReleaseNumber $releaseNumber
          Write-Host "Release number set to: $releaseNumber"
          
          # ============================================================================
          # SECTION 12: Add-PipelineBuildTag - Build Tags
          # ============================================================================
          Write-PipelineSection -Text "12. Build Tags (Add-PipelineBuildTag)" -Boxed
          Add-PipelineBuildTag -Tag "showcase"
          Add-PipelineBuildTag -Tag "automated"
          Add-PipelineBuildTag -Tag "public-commands"
          Write-Host "Build tags added: showcase, automated, public-commands"
          
          # ============================================================================
          # SECTION 13: Add-PipelinePath - PATH Management
          # ============================================================================
          Write-PipelineSection -Text "13. PATH Management (Add-PipelinePath)" -Boxed
          
          Write-Host "Current PATH before adding new directory:" -ForegroundColor Yellow
          $currentPath = $env:PATH -split [IO.Path]::PathSeparator
          Write-Host "Number of directories in PATH: $($currentPath.Count)"
          Write-Host "First 5 directories:" -ForegroundColor Cyan
          $currentPath | Select-Object -First 5 | ForEach-Object { Write-Host "  - $_" }
          
          $toolsPath = "${{ github.workspace }}/tools/bin"
          Write-Host "Adding to PATH: $toolsPath" -ForegroundColor Cyan
          Add-PipelinePath -Path $toolsPath
          
          Write-Host "New PATH after adding directory:" -ForegroundColor Yellow
          $newPath = $env:PATH -split [IO.Path]::PathSeparator
          Write-Host "Number of directories in PATH: $($newPath.Count)"
          Write-Host "First 5 directories:" -ForegroundColor Cyan
          $newPath | Select-Object -First 5 | ForEach-Object { Write-Host "  - $_" }
          Write-Host "Path successfully added! ‚úì" -ForegroundColor Green
          
          # ============================================================================
          # SECTION 14: Add-PipelineTaskLogFile - Log Files
          # ============================================================================
          Write-PipelineSection -Text "14. Task Log Files (Add-PipelineTaskLogFile)" -Boxed
          $logPath = "${{ github.workspace }}/test-log.txt"
          @"
          This is a test log file
          It can contain any output from the task
          Multiple lines are supported
          "@| Out-File -FilePath $logPath
          Add-PipelineTaskLogFile -Path $logPath
          Write-Host "Log file attached: $logPath"
          
          # ============================================================================
          # SECTION 15: Add-PipelineSummary - Job Summary
          # ============================================================================
          Write-PipelineSection -Text "15. Job Summary (Add-PipelineSummary)" -Boxed
          $summary = @"
          ## PipelineUtils Showcase Summary
          
          ### Commands Demonstrated
          - ‚úÖ Write-PipelineSection
          - ‚úÖ Write-PipelineGroupStart/End
          - ‚úÖ Write-PipelineCommand
          - ‚úÖ Write-PipelineDebug
          - ‚úÖ Write-PipelineWarning
          - ‚úÖ Write-PipelineError
          - ‚úÖ Write-PipelineProgress
          - ‚úÖ Set-PipelineVariable
          - ‚úÖ Set-PipelineSecretValue
          - ‚úÖ Set-PipelineBuildNumber
          - ‚úÖ Set-PipelineReleaseNumber
          - ‚úÖ Add-PipelineBuildTag
          - ‚úÖ Add-PipelinePath
          - ‚úÖ Add-PipelineTaskLogFile
          - ‚úÖ Add-PipelineSummary
          - ‚úÖ Complete-PipelineTask
          
          ### Environment
          - OS: ${{ runner.os }}
          - Runner: ${{ runner.name }}
          - PowerShell: $($PSVersionTable.PSVersion)
          "@
          Add-PipelineSummary -Content $summary
          
          # ============================================================================
          # SECTION 16: Complete-PipelineTask - Task Completion
          # ============================================================================
          Write-PipelineSection -Text "16. Task Completion (Complete-PipelineTask)" -Boxed
          Write-Host "Completing task with success status..."
          Complete-PipelineTask -Status 'Succeeded'
      
      - name: Verify Variables and PATH
        shell: pwsh
        run: |
          Write-Host "============================================================================" -ForegroundColor Cyan
          Write-Host "VERIFICATION: Variables and PATH Set in Previous Step" -ForegroundColor Cyan
          Write-Host "============================================================================" -ForegroundColor Cyan
          
          Write-Host "`n1. Checking SHOWCASE_VAR environment variable:" -ForegroundColor Yellow
          if ($env:SHOWCASE_VAR) {
            Write-Host "   ‚úÖ SHOWCASE_VAR = $env:SHOWCASE_VAR" -ForegroundColor Green
          }
          else {
            Write-Host "   ‚ö†Ô∏è  SHOWCASE_VAR not found in this step (this is expected for environment variables)" -ForegroundColor Yellow
          }
          
          Write-Host "`n2. Checking if tools directory would be in PATH:" -ForegroundColor Yellow
          $toolsPath = "${{ github.workspace }}/tools/bin"
          $pathDirs = $env:PATH -split [IO.Path]::PathSeparator
          if ($pathDirs -contains $toolsPath) {
            Write-Host "   ‚úÖ Tools path is in PATH: $toolsPath" -ForegroundColor Green
          }
          else {
            Write-Host "   ‚ÑπÔ∏è  Tools path not yet in this step's PATH (added in previous step)" -ForegroundColor Cyan
            Write-Host "   üìå In real workflows, subsequent steps would have access to this path" -ForegroundColor Cyan
          }
          
          Write-Host "`n3. Current PATH directories (first 10):" -ForegroundColor Yellow
          $pathDirs | Select-Object -First 10 | ForEach-Object { 
            Write-Host "   - $_" -ForegroundColor Gray
          }
          
          Write-Host "`n‚úÖ Verification complete!`n" -ForegroundColor Green

